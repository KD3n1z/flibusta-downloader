import { Telegraf } from "telegraf";
import jsdom from 'jsdom';
import axios from "axios";
import { InlineKeyboardButton, Message } from "telegraf/typings/core/types/typegram";

require('dotenv').config();

const bot = new Telegraf(process.env.BOT_TOKEN as string);

let bannedBooks: string[] = [];

bot.on('message', async (ctx) => {
    if(ctx.update.message.chat.type == 'private') {
        const text: string = (ctx.update.message as any).text;
        if(text) {
            if(text.startsWith("/")) {  
                if(text.startsWith("/start")) { 
                    ctx.reply('–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –≤ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –∫–Ω–∏–≥ —Å <a href="http://flibusta.site/">—Ñ–ª–∏–±—É—Å—Ç—ã</a>. üìö –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª—é–±–æ–π –∫–Ω–∏–≥–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, 1984 üìï', {parse_mode: "HTML"});
                }
                return;
            }
            try {
                const msg: Message = await ctx.reply("–ò—â–µ–º –∫–Ω–∏–≥—É \"" + (text.length <= 20 ? text : text.slice(0, 20) + "...") + "\" ‚åõ");
                const resp = await axios.get('http://flibusta.site/booksearch?ask=' + encodeURI(text));

                const links: NodeListOf<Element> = new jsdom.JSDOM(resp.data).window.document.querySelectorAll("#main>ul>li>a");
                let limit: number = 5;

                let buttons: InlineKeyboardButton[][] = [];

                for(const link of links) {
                    if(limit == 0) {
                        break;
                    }
                    
                    if((link as HTMLElement).getAttribute('href')) {
                        if(((link as HTMLElement).getAttribute('href') as string).startsWith('/b/')) {
                            let id: string = link.getAttribute('href')?.split('/')[2] as string;
                            if(!bannedBooks.includes(id)) {
                                buttons.push(
                                    [{
                                        text: (link.parentElement as HTMLElement).textContent as string,
                                        callback_data: id
                                    }]);
                                limit--;
                            }
                        }
                    }
                }
                if(buttons.length > 0) {
                    await ctx.telegram.editMessageText(
                        msg.chat.id,
                        msg.message_id,
                        undefined,
                        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É... üìï"
                    );
                    await ctx.telegram.editMessageReplyMarkup(
                        msg.chat.id,
                        msg.message_id,
                        undefined,
                        {inline_keyboard: buttons}
                    );
                }else{
                    await ctx.telegram.editMessageText(
                        msg.chat.id,
                        msg.message_id,
                        undefined,
                        "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ! üòî"
                    );
                }
            } catch {}
        }
    }
});

bot.on('callback_query', async (ctx) => {
    try{
        const data = (ctx.update.callback_query as any).data;
        if(data) {
            const msg: Message = await ctx.reply("–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ /b/" + data + " ‚åõ");
            try{
                if(ctx.update.callback_query.message) {
                    await ctx.telegram.deleteMessage(ctx.update.callback_query.message.chat.id, ctx.update.callback_query.message.message_id);
                }
                ctx.answerCbQuery();
                const resp = await axios.get('http://flibusta.site/b/' + data)
                const document: Document = new jsdom.JSDOM(resp.data).window.document;
                const title: string = (document.querySelectorAll("#main>a")[0].textContent as string).trim() + " - " + (document.querySelector(".title")?.textContent as string).split('(fb2)')[0].trim();
                await ctx.telegram.editMessageText(
                        msg.chat.id,
                        msg.message_id,
                        undefined,
                        "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ \"" + title + "\" ‚åõ"
                    );

                let fb2 = false;

                for(let link of document.querySelectorAll('a')) {
                    if(link.getAttribute('href') == '/b/' + data + '/fb2') {
                        fb2 = true;
                        break;
                    }
                }

                if(fb2) {
                    ctx.replyWithDocument({
                        url: 'http://flibusta.site/b/' + data + '/fb2',
                        filename: title.replace(/[^—ë–∞-—èa-z0-9-]/gi, "") + ".zip"
                    }).then(() => {
                        ctx.telegram.editMessageText(
                            msg.chat.id,
                            msg.message_id,
                            undefined,
                            "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ \"" + title + "\" ‚úÖ"
                        );
                    });
                }else{
                    ctx.reply("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ - –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Ñ–∞–π–ª–∞! üòî");
                    if(!bannedBooks.includes(data)) {
                        bannedBooks.push(data);
                    }
                }
            }catch {
                await ctx.telegram.editMessageText(
                    msg.chat.id,
                    msg.message_id,
                    undefined,
                    "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏! üòî"
                );
            }
        }
    }catch{}
});

console.log("bot started");

bot.launch();